name: build

on: [push]

jobs:
  build:
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    runs-on: ubuntu-latest

    steps:
    - name: remove tag
      uses: dev-drprasad/delete-tag-and-release@master
      with:
        delete_release: false
        tag_name: Latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - uses: actions/checkout@master
    - name: submodule update
      run: git submodule update --init
    - name: create source package
      run: tar -C .. -cjf ../GxPlugins.tar.bz2 $(basename $(pwd))
    - name: install lv2
      run: |
        sudo apt-get install lv2-dev debhelper fakeroot
    - name: build deb
      run: dpkg-buildpackage -rfakeroot -uc -us -b
    - name: Create Release
      id: create_release
      uses: actions/create-release@master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          tag_name: Latest
          release_name: Release latest
          draft: false
          prerelease: true
    - name: Upload Release Asset (Source code)
      id: upload-release-asset-src
      uses: actions/upload-release-asset@master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ../GxPlugins.tar.bz2
          asset_name: gxplugins_1.0_src.tar.bz2
          asset_content_type: application
    - name: Upload Release Asset (Debian package)
      id: upload-release-asset-deb
      uses: actions/upload-release-asset@master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ../gxplugins_1.0_amd64.deb
          asset_name: gxplugins_1.0_amd64.deb
          asset_content_type: application

  build-win:
    needs: build
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          base-devel
          git
          make
          mingw-w64-x86_64-gcc
          mingw-w64-x86_64-lv2
          mingw-w64-x86_64-cairo
          mingw-w64-x86_64-pkgconf
          pkgconf
          mingw-w64-x86_64-7zip
    - uses: actions/checkout@master
    - name: submodule update
      run: git submodule update --init
    - name: make
      run: make -j && make DESTDIR=$(pwd)/_bin install
    - name: add license and readme
      run: cp LICENSE README.md _bin~/.lv2/
    - name: zip
      run: mv _bin~/.lv2 _bin~/lv2 ; cd _bin~ ; 7z a -mx9 ../plugin.7z lv2 ; cd ..
    - name: upload
      id: upload-release-asset
      uses: actions/upload-release-asset@master
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
          upload_url: ${{ needs.build.outputs.upload_url }}
          asset_path: plugin.7z
          asset_name: gxplugins_1.0_win64.7z
          asset_content_type: application
